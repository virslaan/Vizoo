<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vizoo - Homepage of All</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #000000;
            --bg-secondary: #050505;
            --bg-tertiary: #0a0a0a;
            --text: #ffffff;
            --text-secondary: #888888;
            --border: #1a1a1a;
            --hover: #0f0f0f;
            --accent: #60AAD8;
            --accent-hover: #4a8fc4;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        /* Header - Netflix Style */
        .header {
            padding: 16px 60px;
            display: flex;
            align-items: center;
            gap: 24px;
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.3px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .header-search {
            flex: 1;
            max-width: 600px;
            position: relative;
        }

        .header-search-input {
            width: 100%;
            padding: 12px 40px 12px 18px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            font-size: 15px;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            outline: none;
            transition: all 0.2s;
        }

        .header-search-input:focus {
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .header-search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--text-secondary);
            pointer-events: none;
        }

        .header-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-shrink: 0;
        }

        .header-btn {
            padding: 5px 10px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.15s;
            opacity: 0.7;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.03);
            color: var(--text);
            opacity: 1;
        }

        /* Hero Section - Netflix Style */
        .hero {
            padding: 120px 40px 80px;
            text-align: center;
            max-width: 100%;
            margin: 0 auto;
            position: relative;
        }

        .hero.hidden {
            display: none;
        }

        .hero-title {
            font-size: 64px;
            font-weight: 700;
            margin-bottom: 16px;
            letter-spacing: -0.03em;
            color: var(--text);
            text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
        }

        .hero-subtitle {
            font-size: 20px;
            color: var(--text-secondary);
            margin-bottom: 48px;
            font-weight: 400;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Hero search - hidden when search is in header */
        .hero-search {
            display: none;
        }

        /* Mode Chips - Netflix Style */
        .mode-chips {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-chip {
            padding: 10px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .mode-chip:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .mode-chip.active {
            background: var(--accent);
            color: var(--bg);
            box-shadow: 0 4px 12px rgba(96, 170, 216, 0.4);
        }

        /* Autocomplete - Dark Glass */
        .autocomplete {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            background: rgba(5, 5, 5, 0.98);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            max-height: 360px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete.visible {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .autocomplete-section {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .autocomplete-section:last-child {
            border-bottom: none;
        }

        .autocomplete-section-title {
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.6;
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.15s;
            border-radius: 6px;
            margin: 2px 6px;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: rgba(255, 255, 255, 0.08);
        }

        .autocomplete-item-icon {
            width: 18px;
            height: 18px;
            color: var(--text-secondary);
            flex-shrink: 0;
            opacity: 0.7;
        }

        .autocomplete-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .autocomplete-item-text {
            font-size: 14px;
            color: var(--text);
            font-weight: 400;
        }

        .autocomplete-item-desc {
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .autocomplete-item-badge {
            padding: 2px 6px;
            background: rgba(96, 170, 216, 0.15);
            color: var(--accent);
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            margin-left: auto;
        }

        /* Results - Netflix Style Rows */
        .results-section {
            display: none;
            padding: 40px 60px;
            padding-right: 400px; /* Space for sidebar */
        }

        .results-section.visible {
            display: block;
        }

        .result-row {
            margin-bottom: 48px;
        }

        .result-row-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
            padding-left: 4px;
            letter-spacing: 0.3px;
        }

        .result-row-carousel {
            position: relative;
            margin: 0 -60px;
            padding: 0 60px;
        }

        .result-row-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding: 12px 0 40px;
        }

        .result-row-container::-webkit-scrollbar {
            display: none;
        }

        .result-card {
            flex: 0 0 300px;
            border-radius: 4px;
            overflow: hidden;
            background: #181818;
            display: flex;
            flex-direction: column;
            height: 450px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            border: none;
        }

        .result-card:hover {
            transform: scale(1.1) translateY(-8px);
            z-index: 10;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.8);
        }

        .result-card-poster {
            width: 100%;
            height: 320px;
            background: #2f2f2f;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-card-embed {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            background: var(--bg);
        }

        .result-card-preview {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px;
            text-align: center;
            z-index: 2;
            background: #181818;
        }

        .result-card-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .result-card-preview-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .result-card-preview-url {
            font-size: 13px;
            color: #808080;
            margin-bottom: 24px;
        }

        .result-card-preview-btn {
            padding: 12px 24px;
            background: var(--accent);
            color: var(--bg);
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .result-card-preview-btn:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        .result-card-info {
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: #181818;
        }

        .result-card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .result-card-url {
            font-size: 11px;
            color: #808080;
            margin-bottom: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .result-card-actions {
            display: flex;
            gap: 8px;
        }

        .result-card-btn {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .result-card-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .result-card-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text);
        }

        .result-card-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .pin-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .pin-btn:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .pin-btn.pinned {
            background: rgba(96, 170, 216, 0.15);
            color: var(--accent);
            border-color: rgba(96, 170, 216, 0.3);
        }

        .pin-btn.pinned:hover {
            background: rgba(96, 170, 216, 0.25);
            border-color: rgba(96, 170, 216, 0.4);
        }

        .pin-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Sidebar - Dark Minimal */
        .sidebar {
            position: fixed;
            right: 0;
            top: 0;
            width: 340px;
            height: 100vh;
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.04);
            z-index: 200;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
        }

        .sidebar-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .sidebar-close:hover {
            background: var(--hover);
            color: var(--text);
        }

        .sidebar-actions {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }

        .sidebar-btn {
            flex: 1;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar-btn:hover {
            background: var(--hover);
            border-color: var(--accent);
        }

        .sidebar-content {
            flex: 1;
            padding: 24px;
        }

        .collection {
            margin-bottom: 32px;
        }

        .collection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .collection-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .collection-count {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .pinned-item {
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pinned-item:hover {
            background: var(--hover);
            border-color: var(--accent);
        }

        .pinned-item-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .pinned-item-url {
            font-size: 11px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .pinned-item-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .pinned-item-btn {
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pinned-item-btn:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .empty-collection {
            text-align: center;
            padding: 32px 16px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Command Palette */
        .command-palette {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .command-palette.visible {
            display: flex;
        }

        .command-palette-content {
            width: 100%;
            max-width: 600px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .command-palette-input {
            width: 100%;
            padding: 20px 24px;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 18px;
            font-family: inherit;
            outline: none;
        }

        .command-palette-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .command-item {
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        /* Footer */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px 60px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .footer:hover {
            opacity: 1;
        }

        .footer-credit {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
        }

        .footer-credit a {
            color: var(--accent);
            text-decoration: none;
            transition: opacity 0.2s ease;
        }

        .footer-credit a:hover {
            opacity: 0.8;
        }

        .command-item:hover,
        .command-item.selected {
            background: var(--bg-tertiary);
        }

        .command-item-icon {
            width: 20px;
            height: 20px;
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .command-item-icon svg {
            width: 100%;
            height: 100%;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .header {
                padding: 12px 20px;
                flex-wrap: wrap;
                gap: 12px;
            }

            .logo {
                font-size: 20px;
            }

            .header-search {
                order: 3;
                width: 100%;
                max-width: 100%;
                margin-top: 8px;
            }

            .header-search-input {
                padding: 10px 36px 10px 14px;
                font-size: 14px;
            }

            .header-search-icon {
                width: 16px;
                height: 16px;
                right: 10px;
            }

            .hero {
                padding: 60px 20px 40px;
            }

            .hero-title {
                font-size: 42px;
            }

            .hero-subtitle {
                font-size: 16px;
            }

            .results-section {
                padding: 24px 20px;
                padding-right: 20px;
            }

            .result-row-carousel {
                margin: 0 -20px;
                padding: 0 20px;
            }

            .result-card {
                flex: 0 0 240px;
                height: 380px;
            }

            .result-card-poster {
                height: 260px;
            }

            .results-section {
                padding: 24px 20px;
            }

            .result-row-carousel {
                margin: 0 -20px;
                padding: 0 20px;
            }

            .footer {
                padding: 10px 20px;
                font-size: 10px;
            }

            .result-card {
                flex: 0 0 260px;
                height: 420px;
            }

            .result-card-poster {
                height: 300px;
            }

            .sidebar {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">Vizoo</div>
        <div class="header-search">
            <input 
                type="text" 
                class="header-search-input" 
                id="searchInput" 
                placeholder="Search the web, shopping, AI, community..."
                autocomplete="off"
            />
            <svg class="header-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <div class="autocomplete" id="autocomplete"></div>
        </div>
        <div class="header-actions">
            <button class="header-btn" id="sidebarToggle">Pinned</button>
            <button class="header-btn" id="commandPaletteBtn">âŒ˜K</button>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="hero">
        <h1 class="hero-title">Vizoo</h1>
        <p class="hero-subtitle">Search everything. Save anything.</p>
        <div class="mode-chips" id="modeChips">
            <button class="mode-chip active" data-mode="all">All</button>
            <button class="mode-chip" data-mode="web">Web</button>
            <button class="mode-chip" data-mode="shopping">Shopping</button>
            <button class="mode-chip" data-mode="ai">AI</button>
            <button class="mode-chip" data-mode="social">Social</button>
            <button class="mode-chip" data-mode="saved">Saved</button>
        </div>
    </section>

    <!-- Results Section -->
    <section class="results-section" id="resultsSection">
        <!-- Results will be populated here -->
    </section>

    <!-- Sidebar - Pinned Board -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title">Pinned</h2>
            <button class="sidebar-close" id="sidebarClose">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="sidebar-actions">
            <button class="sidebar-btn" id="exportBtn">Export</button>
            <button class="sidebar-btn" id="clearBtn">Clear</button>
        </div>
        <div class="sidebar-content" id="sidebarContent">
            <!-- Collections will be populated here -->
        </div>
    </aside>

    <!-- Command Palette -->
    <div class="command-palette" id="commandPalette">
        <div class="command-palette-content">
            <input 
                type="text" 
                class="command-palette-input" 
                id="commandInput" 
                placeholder="Type a command..."
                autocomplete="off"
            />
            <div class="command-palette-results" id="commandResults"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-credit">
            Vizoo by <a href="https://linkedin.com/in/vipulhharihar" target="_blank" rel="noopener noreferrer">linkedin/vipulhharihar</a>
        </div>
    </footer>

    <script>
        // State
        const state = {
            query: '',
            mode: 'all',
            results: {},
            pinned: {
                today: [],
                research: [],
                shopping: [],
                work: []
            },
            recentSearches: [],
            autocompleteSuggestions: [],
            selectedIndex: -1
        };

        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const autocomplete = document.getElementById('autocomplete');
        const hero = document.getElementById('hero');
        const resultsSection = document.getElementById('resultsSection');
        const modeChips = document.getElementById('modeChips');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarClose = document.getElementById('sidebarClose');
        const sidebarContent = document.getElementById('sidebarContent');
        const commandPalette = document.getElementById('commandPalette');
        const commandPaletteBtn = document.getElementById('commandPaletteBtn');
        const commandInput = document.getElementById('commandInput');
        const commandResults = document.getElementById('commandResults');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');

        // Load from localStorage
        try {
            const saved = localStorage.getItem('vizoo_pinned');
            if (saved) state.pinned = JSON.parse(saved);
            state.recentSearches = JSON.parse(localStorage.getItem('vizoo_recent') || '[]');
        } catch (e) {}

        // Save pinned
        function savePinned() {
            try {
                localStorage.setItem('vizoo_pinned', JSON.stringify(state.pinned));
            } catch (e) {}
        }

        // Event Listeners
        searchInput.addEventListener('input', handleInput);
        searchInput.addEventListener('keydown', handleKeyDown);
        searchInput.addEventListener('focus', () => {
            if (state.autocompleteSuggestions.length > 0) {
                autocomplete.classList.add('visible');
            } else if (searchInput.value.trim() === '') {
                showRecommendations();
            }
        });

        modeChips.addEventListener('click', (e) => {
            if (e.target.classList.contains('mode-chip')) {
                modeChips.querySelectorAll('.mode-chip').forEach(chip => chip.classList.remove('active'));
                e.target.classList.add('active');
                state.mode = e.target.dataset.mode;
                if (state.query) performSearch();
            }
        });

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        sidebarClose.addEventListener('click', () => {
            sidebar.classList.remove('open');
        });

        commandPaletteBtn.addEventListener('click', () => {
            commandPalette.classList.add('visible');
            commandInput.focus();
        });

        commandPalette.addEventListener('click', (e) => {
            if (e.target === commandPalette) {
                commandPalette.classList.remove('visible');
            }
        });

        commandInput.addEventListener('input', updateCommandPalette);
        commandInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                commandPalette.classList.remove('visible');
            } else if (e.key === 'Enter') {
                const selected = commandResults.querySelector('.command-item.selected');
                if (selected) {
                    selected.click();
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                navigateCommands(1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                navigateCommands(-1);
            }
        });


        exportBtn.addEventListener('click', exportPinned);
        clearBtn.addEventListener('click', clearPinned);

        // Command Palette Commands
        const commands = [
            {
                id: 'pinned',
                title: 'Open Pinned',
                description: 'View your pinned items',
                icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L9 8l-7 1 5 5-1 7 6-3 6 3-1-7 5-5-7-1z"/></svg>',
                action: () => {
                    commandPalette.classList.remove('visible');
                    sidebar.classList.add('open');
                }
            },
            {
                id: 'export',
                title: 'Export Pinned',
                description: 'Export all pinned items as Markdown',
                icon: 'ðŸ“¤',
                action: () => {
                    commandPalette.classList.remove('visible');
                    exportPinned();
                }
            },
            {
                id: 'clear',
                title: 'Clear Pinned',
                description: 'Remove all pinned items',
                icon: 'ðŸ—‘ï¸',
                action: () => {
                    commandPalette.classList.remove('visible');
                    clearPinned();
                }
            },
            {
                id: 'search-web',
                title: 'Search Web',
                description: 'Switch to web search mode',
                icon: 'ðŸŒ',
                action: () => {
                    commandPalette.classList.remove('visible');
                    modeChips.querySelectorAll('.mode-chip').forEach(chip => chip.classList.remove('active'));
                    modeChips.querySelector('[data-mode="web"]').classList.add('active');
                    state.mode = 'web';
                    if (state.query) performSearch();
                }
            },
            {
                id: 'search-shopping',
                title: 'Search Shopping',
                description: 'Switch to shopping search mode',
                icon: 'ðŸ›’',
                action: () => {
                    commandPalette.classList.remove('visible');
                    modeChips.querySelectorAll('.mode-chip').forEach(chip => chip.classList.remove('active'));
                    modeChips.querySelector('[data-mode="shopping"]').classList.add('active');
                    state.mode = 'shopping';
                    if (state.query) performSearch();
                }
            },
            {
                id: 'search-ai',
                title: 'Search AI',
                description: 'Switch to AI search mode',
                icon: 'ðŸ¤–',
                action: () => {
                    commandPalette.classList.remove('visible');
                    modeChips.querySelectorAll('.mode-chip').forEach(chip => chip.classList.remove('active'));
                    modeChips.querySelector('[data-mode="ai"]').classList.add('active');
                    state.mode = 'ai';
                    if (state.query) performSearch();
                }
            },
            {
                id: 'search-social',
                title: 'Search Social',
                description: 'Switch to social search mode',
                icon: 'ðŸ’¬',
                action: () => {
                    commandPalette.classList.remove('visible');
                    modeChips.querySelectorAll('.mode-chip').forEach(chip => chip.classList.remove('active'));
                    modeChips.querySelector('[data-mode="social"]').classList.add('active');
                    state.mode = 'social';
                    if (state.query) performSearch();
                }
            }
        ];

        let commandSelectedIndex = -1;

        function updateCommandPalette() {
            const query = commandInput.value.toLowerCase().trim();
            const filtered = commands.filter(cmd => 
                cmd.title.toLowerCase().includes(query) || 
                cmd.description.toLowerCase().includes(query)
            );
            
            commandSelectedIndex = -1;
            
            if (filtered.length === 0) {
                commandResults.innerHTML = '<div class="command-item"><div class="command-item-text" style="color: var(--text-secondary);">No commands found</div></div>';
                return;
            }
            
            commandResults.innerHTML = filtered.map((cmd, index) => `
                <div class="command-item ${index === commandSelectedIndex ? 'selected' : ''}" data-index="${index}" data-command-id="${cmd.id}">
                    <div class="command-item-icon">${cmd.icon}</div>
                    <div style="flex: 1;">
                        <div class="command-item-text">${cmd.title}</div>
                        <div class="command-item-desc">${cmd.description}</div>
                    </div>
                </div>
            `).join('');
            
            commandResults.querySelectorAll('.command-item').forEach(item => {
                item.addEventListener('click', () => {
                    const cmdId = item.dataset.commandId;
                    const cmd = commands.find(c => c.id === cmdId);
                    if (cmd) cmd.action();
                });
            });
        }

        function navigateCommands(direction) {
            const items = commandResults.querySelectorAll('.command-item');
            if (items.length === 0) return;
            
            commandSelectedIndex += direction;
            if (commandSelectedIndex < 0) commandSelectedIndex = items.length - 1;
            if (commandSelectedIndex >= items.length) commandSelectedIndex = 0;
            
            items.forEach((item, index) => {
                item.classList.toggle('selected', index === commandSelectedIndex);
            });
            
            items[commandSelectedIndex].scrollIntoView({ block: 'nearest' });
        }

        // Initialize command palette
        commandPalette.addEventListener('click', () => {
            updateCommandPalette();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                commandPalette.classList.toggle('visible');
                if (commandPalette.classList.contains('visible')) {
                    commandInput.value = '';
                    commandInput.focus();
                    updateCommandPalette();
                }
            }
        });

        // Autocomplete
        let autocompleteTimeout;
        function handleInput(e) {
            const query = e.target.value.trim();
            state.query = query;

            clearTimeout(autocompleteTimeout);
            if (query.length > 0) {
                autocompleteTimeout = setTimeout(() => fetchAutocomplete(query), 200);
            } else {
                // Show recommendations when empty
                showRecommendations();
            }
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (state.selectedIndex >= 0 && state.autocompleteSuggestions.length > 0) {
                    const selected = state.autocompleteSuggestions[state.selectedIndex];
                    searchInput.value = selected.text || selected;
                    autocomplete.classList.remove('visible');
                    performSearch();
                } else {
                    performSearch();
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                navigateAutocomplete(1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                navigateAutocomplete(-1);
            } else if (e.key === 'Escape') {
                autocomplete.classList.remove('visible');
            }
        }

        // Popular/trending searches
        const popularSearches = [
            'artificial intelligence',
            'machine learning',
            'web development',
            'python programming',
            'javascript tutorial',
            'react framework',
            'best laptops 2024',
            'climate change',
            'space exploration',
            'quantum computing'
        ];

        // Search operators suggestions
        const searchOperators = [
            { text: '!g', desc: 'Search Google', type: 'operator' },
            { text: '!ddg', desc: 'Search DuckDuckGo', type: 'operator' },
            { text: '!a', desc: 'Search Amazon', type: 'operator' },
            { text: '!y', desc: 'Search YouTube', type: 'operator' },
            { text: '!w', desc: 'Search Wikipedia', type: 'operator' },
            { text: '?', desc: 'Ask AI', type: 'operator' }
        ];

        async function fetchAutocomplete(query) {
            const suggestions = [];
            
            if (query.length === 0) {
                showRecommendations();
                return;
            }

            const lowerQuery = query.toLowerCase();
            
            // Search operators (if query starts with ! or ?)
            if (query.startsWith('!') || query.startsWith('?')) {
                searchOperators
                    .filter(op => op.text.toLowerCase().startsWith(lowerQuery))
                    .slice(0, 4)
                    .forEach(op => {
                        suggestions.push(op);
                    });
            }
            
            // Recent searches
            state.recentSearches
                .filter(s => s.toLowerCase().includes(lowerQuery))
                .slice(0, 4)
                .forEach(s => {
                    suggestions.push({ text: s, type: 'recent', desc: 'Recent search' });
                });
            
            // Pinned items
            Object.values(state.pinned).flat()
                .filter(item => item.title.toLowerCase().includes(lowerQuery))
                .slice(0, 3)
                .forEach(item => {
                    suggestions.push({ text: item.title, type: 'pinned', url: item.url, desc: 'Pinned item' });
                });
            
            // Popular searches matching query
            popularSearches
                .filter(s => s.toLowerCase().includes(lowerQuery) && !state.recentSearches.includes(s))
                .slice(0, 3)
                .forEach(s => {
                    suggestions.push({ text: s, type: 'popular', desc: 'Popular search' });
                });
            
            // Try DuckDuckGo instant answers
            if (query.length > 3) {
                try {
                    const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_redirect=1&skip_disambig=1`);
                    const data = await response.json();
                    if (data.Answer) {
                        suggestions.unshift({
                            text: query,
                            type: 'instant',
                            desc: data.Answer.substring(0, 50) + '...',
                            url: data.AbstractURL
                        });
                    }
                } catch (e) {}
            }
            
            state.autocompleteSuggestions = suggestions.slice(0, 8);
            state.selectedIndex = -1;
            updateAutocomplete();
        }

        function showRecommendations() {
            const suggestions = [];
            
            // Recent searches (up to 4)
            state.recentSearches.slice(0, 4).forEach(s => {
                suggestions.push({ text: s, type: 'recent', desc: 'Recent search' });
            });
            
            // Popular searches (if no recent)
            if (suggestions.length < 6) {
                popularSearches
                    .filter(s => !state.recentSearches.includes(s))
                    .slice(0, 6 - suggestions.length)
                    .forEach(s => {
                        suggestions.push({ text: s, type: 'popular', desc: 'Popular search' });
                    });
            }
            
            // Search operators
            searchOperators.slice(0, 3).forEach(op => {
                suggestions.push(op);
            });
            
            state.autocompleteSuggestions = suggestions;
            state.selectedIndex = -1;
            updateAutocomplete();
        }

        function updateAutocomplete() {
            if (state.autocompleteSuggestions.length === 0) {
                autocomplete.classList.remove('visible');
                return;
            }

            // Group suggestions by type
            const grouped = {
                instant: [],
                operator: [],
                recent: [],
                pinned: [],
                popular: []
            };

            state.autocompleteSuggestions.forEach(item => {
                const type = item.type || 'popular';
                if (grouped[type]) {
                    grouped[type].push(item);
                }
            });

            let html = '';

            // Instant answers
            if (grouped.instant.length > 0) {
                html += '<div class="autocomplete-section"><div class="autocomplete-section-title">Instant Answer</div>';
                grouped.instant.forEach((item, index) => {
                    const globalIndex = state.autocompleteSuggestions.indexOf(item);
                    html += createAutocompleteItem(item, globalIndex);
                });
                html += '</div>';
            }

            // Search operators
            if (grouped.operator.length > 0) {
                html += '<div class="autocomplete-section"><div class="autocomplete-section-title">Quick Actions</div>';
                grouped.operator.forEach((item, index) => {
                    const globalIndex = state.autocompleteSuggestions.indexOf(item);
                    html += createAutocompleteItem(item, globalIndex);
                });
                html += '</div>';
            }

            // Recent searches
            if (grouped.recent.length > 0) {
                html += '<div class="autocomplete-section"><div class="autocomplete-section-title">Recent</div>';
                grouped.recent.forEach((item, index) => {
                    const globalIndex = state.autocompleteSuggestions.indexOf(item);
                    html += createAutocompleteItem(item, globalIndex);
                });
                html += '</div>';
            }

            // Pinned items
            if (grouped.pinned.length > 0) {
                html += '<div class="autocomplete-section"><div class="autocomplete-section-title">Pinned</div>';
                grouped.pinned.forEach((item, index) => {
                    const globalIndex = state.autocompleteSuggestions.indexOf(item);
                    html += createAutocompleteItem(item, globalIndex);
                });
                html += '</div>';
            }

            // Popular searches
            if (grouped.popular.length > 0) {
                html += '<div class="autocomplete-section"><div class="autocomplete-section-title">Popular</div>';
                grouped.popular.forEach((item, index) => {
                    const globalIndex = state.autocompleteSuggestions.indexOf(item);
                    html += createAutocompleteItem(item, globalIndex);
                });
                html += '</div>';
            }

            autocomplete.innerHTML = html;

            autocomplete.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    const selected = state.autocompleteSuggestions[index];
                    searchInput.value = selected.text || selected;
                    autocomplete.classList.remove('visible');
                    if (selected.url) {
                        window.open(selected.url, '_blank');
                    } else {
                        performSearch();
                    }
                });
            });

            autocomplete.classList.add('visible');
        }

        function createAutocompleteItem(item, index) {
            const isSelected = index === state.selectedIndex;
            let icon = '';
            let badge = '';

            switch(item.type) {
                case 'recent':
                    icon = '<svg class="autocomplete-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>';
                    break;
                case 'pinned':
                    icon = '<svg class="autocomplete-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>';
                    break;
                case 'operator':
                    icon = '<svg class="autocomplete-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>';
                    badge = '<span class="autocomplete-item-badge">Quick</span>';
                    break;
                case 'instant':
                    icon = '<svg class="autocomplete-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
                    badge = '<span class="autocomplete-item-badge">Answer</span>';
                    break;
                case 'popular':
                    icon = '<svg class="autocomplete-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>';
                    break;
                default:
                    icon = '<svg class="autocomplete-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>';
            }

            return `
                <div class="autocomplete-item ${isSelected ? 'selected' : ''}" data-index="${index}">
                    ${icon}
                    <div class="autocomplete-item-content">
                        <div class="autocomplete-item-text">${escapeHtml(item.text || item)}</div>
                        ${item.desc ? `<div class="autocomplete-item-desc">${escapeHtml(item.desc)}</div>` : ''}
                    </div>
                    ${badge}
                </div>
            `;
        }

        function navigateAutocomplete(direction) {
            if (state.autocompleteSuggestions.length === 0) return;
            
            state.selectedIndex += direction;
            if (state.selectedIndex < 0) state.selectedIndex = state.autocompleteSuggestions.length - 1;
            if (state.selectedIndex >= state.autocompleteSuggestions.length) state.selectedIndex = 0;
            
            updateAutocomplete();
        }

        // Search
        async function performSearch() {
            let query = searchInput.value.trim();
            if (!query) return;

            // Handle search operators
            let actualQuery = query;
            let operatorMode = null;
            
            if (query.startsWith('!g ') || query.startsWith('!google ')) {
                actualQuery = query.replace(/^!g(oogle)?\s+/, '');
                operatorMode = 'google';
                modeChips.querySelectorAll('.mode-chip').forEach(chip => chip.classList.remove('active'));
                modeChips.querySelector('[data-mode="web"]').classList.add('active');
                state.mode = 'web';
            } else if (query.startsWith('!ddg ') || query.startsWith('!duckduckgo ')) {
                actualQuery = query.replace(/^!ddg|!duckduckgo\s+/, '');
                operatorMode = 'duckduckgo';
                modeChips.querySelectorAll('.mode-chip').forEach(chip => chip.classList.remove('active'));
                modeChips.querySelector('[data-mode="web"]').classList.add('active');
                state.mode = 'web';
            } else if (query.startsWith('!a ') || query.startsWith('!amazon ')) {
                actualQuery = query.replace(/^!a|!amazon\s+/, '');
                operatorMode = 'amazon';
                modeChips.querySelectorAll('.mode-chip').forEach(chip => chip.classList.remove('active'));
                modeChips.querySelector('[data-mode="shopping"]').classList.add('active');
                state.mode = 'shopping';
            } else if (query.startsWith('!y ') || query.startsWith('!youtube ')) {
                actualQuery = query.replace(/^!y|!youtube\s+/, '');
                operatorMode = 'youtube';
                modeChips.querySelectorAll('.mode-chip').forEach(chip => chip.classList.remove('active'));
                modeChips.querySelector('[data-mode="social"]').classList.add('active');
                state.mode = 'social';
            } else if (query.startsWith('!w ') || query.startsWith('!wiki ')) {
                actualQuery = query.replace(/^!w|!wiki\s+/, '');
                operatorMode = 'wikipedia';
                modeChips.querySelectorAll('.mode-chip').forEach(chip => chip.classList.remove('active'));
                modeChips.querySelector('[data-mode="web"]').classList.add('active');
                state.mode = 'web';
            } else if (query.startsWith('?') || query.startsWith('!ai ')) {
                actualQuery = query.replace(/^[?!]|!ai\s+/, '');
                operatorMode = 'ai';
                modeChips.querySelectorAll('.mode-chip').forEach(chip => chip.classList.remove('active'));
                modeChips.querySelector('[data-mode="ai"]').classList.add('active');
                state.mode = 'ai';
            }

            state.query = actualQuery || query;
            autocomplete.classList.remove('visible');
            
            // Save to recent (save the original query)
            if (!state.recentSearches.includes(query)) {
                state.recentSearches.unshift(query);
                state.recentSearches = state.recentSearches.slice(0, 50);
                try {
                    localStorage.setItem('vizoo_recent', JSON.stringify(state.recentSearches));
                } catch (e) {}
            }

            hero.classList.add('hidden');
            resultsSection.classList.add('visible');
            
            resultsSection.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div>Searching...</div></div>';
            
            // Determine which engines to search based on mode
            let engines = [];
            
            if (operatorMode) {
                engines = [operatorMode];
            } else {
                switch(state.mode) {
                case 'web':
                    engines = ['duckduckgo', 'google', 'bing', 'wikipedia'];
                    break;
                case 'shopping':
                    engines = ['amazon'];
                    break;
                case 'ai':
                    engines = ['chatgpt', 'claude', 'gemini', 'perplexity', 'copilot', 'grok', 'huggingchat', 'you'];
                    break;
                case 'social':
                    engines = ['reddit', 'youtube'];
                    break;
                case 'saved':
                    displaySaved();
                    return;
                default:
                    engines = ['duckduckgo', 'google', 'bing', 'amazon', 'chatgpt', 'claude', 'gemini', 'perplexity', 'copilot', 'grok', 'youtube', 'wikipedia', 'reddit'];
                }
            }
            
            const promises = engines.map(engine => searchWithEngine(engine, state.query));
            await Promise.allSettled(promises);
            
            displayResults();
        }

        async function searchWithEngine(engine, query) {
            try {
                let results = [];
                
                switch(engine) {
                    case 'duckduckgo':
                        results = await searchDuckDuckGo(query);
                        break;
                    case 'google':
                        results = await searchGoogle(query);
                        break;
                    case 'bing':
                        results = await searchBing(query);
                        break;
                    case 'amazon':
                        results = await searchAmazon(query);
                        break;
                    case 'chatgpt':
                        results = await searchChatGPT(query);
                        break;
                    case 'claude':
                        results = await searchClaude(query);
                        break;
                    case 'gemini':
                        results = await searchGemini(query);
                        break;
                    case 'perplexity':
                        results = await searchPerplexity(query);
                        break;
                    case 'copilot':
                        results = await searchCopilot(query);
                        break;
                    case 'grok':
                        results = await searchGrok(query);
                        break;
                    case 'huggingchat':
                        results = await searchHuggingChat(query);
                        break;
                    case 'you':
                        results = await searchYou(query);
                        break;
                    case 'youtube':
                        results = await searchYouTube(query);
                        break;
                    case 'wikipedia':
                        results = await searchWikipedia(query);
                        break;
                    case 'reddit':
                        results = await searchReddit(query);
                        break;
                }
                
                if (!results || results.length === 0) {
                    results = [{
                        url: `https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`,
                        title: `${engine}: ${query}`
                    }];
                }
                
                state.results[engine] = results;
            } catch (error) {
                console.error(`Error searching ${engine}:`, error);
                state.results[engine] = [{
                    url: `https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`,
                    title: `${engine}: ${query}`
                }];
            }
        }

        function displayResults() {
            const engineNames = {
                duckduckgo: 'DuckDuckGo',
                google: 'Google',
                bing: 'Bing',
                amazon: 'Amazon',
                chatgpt: 'ChatGPT',
                claude: 'Claude',
                gemini: 'Gemini',
                perplexity: 'Perplexity',
                copilot: 'Copilot',
                grok: 'Grok',
                huggingchat: 'HuggingChat',
                you: 'You.com',
                youtube: 'YouTube',
                wikipedia: 'Wikipedia',
                reddit: 'Reddit'
            };

            let html = '';
            
            Object.entries(state.results).forEach(([engine, results]) => {
                if (!results || results.length === 0) return;
                
                html += `
                    <div class="result-row">
                        <h3 class="result-row-title">${engineNames[engine] || engine}</h3>
                        <div class="result-row-carousel">
                            <div class="result-row-container">
                                ${results.map((result, index) => {
                                    const safeUrl = result.url || '#';
                                    const title = escapeHtml(result.title || `Result ${index + 1}`);
                                    const displayUrl = safeUrl.replace(/^https?:\/\//, '').replace(/\/$/, '');
                                    const shortUrl = displayUrl.length > 30 ? displayUrl.substring(0, 30) + '...' : displayUrl;
                                    const snippet = result.snippet ? escapeHtml(result.snippet.substring(0, 100)) : '';
                                    const isPinned = isItemPinned(safeUrl);
                                    
                                    const icon = getIcon(safeUrl);
                                    const isYouTubeEmbed = result.embeddable && result.type === 'youtube';
                                    const shouldTryIframe = !isYouTubeEmbed && (result.embeddable || shouldAttemptIframe(safeUrl));
                                    const cardId = `card-${engine}-${index}`;
                                    
                                    return `
                                        <div class="result-card" id="${cardId}">
                                            <div class="result-card-poster">
                                                ${isYouTubeEmbed ? `
                                                    <iframe 
                                                        class="result-card-embed" 
                                                        src="${safeUrl}" 
                                                        frameborder="0" 
                                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                                        allowfullscreen
                                                        title="${title}"
                                                    ></iframe>
                                                ` : shouldTryIframe ? `
                                                    <iframe 
                                                        class="result-card-embed" 
                                                        src="${safeUrl}" 
                                                        frameborder="0" 
                                                        allow="fullscreen"
                                                        title="${title}"
                                                        sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                                                        loading="lazy"
                                                        referrerpolicy="no-referrer-when-downgrade"
                                                    ></iframe>
                                                    <div class="result-card-preview result-card-fallback" style="display: none;">
                                                        <div class="result-card-icon">${icon}</div>
                                                        <div class="result-card-preview-title">${title}</div>
                                                        ${snippet ? `<div style="font-size: 11px; color: var(--text-secondary); margin: 8px 0; line-height: 1.4; max-height: 40px; overflow: hidden; text-align: center; padding: 0 12px;">${snippet}</div>` : ''}
                                                        <div class="result-card-preview-url">${shortUrl}</div>
                                                        <a href="${safeUrl}" target="_blank" class="result-card-preview-btn" onclick="event.stopPropagation()">
                                                            Open â†’
                                                        </a>
                                                    </div>
                                                ` : `
                                                    <div class="result-card-preview">
                                                        <div class="result-card-icon">${icon}</div>
                                                        <div class="result-card-preview-title">${title}</div>
                                                        ${snippet ? `<div style="font-size: 11px; color: var(--text-secondary); margin: 8px 0; line-height: 1.4; max-height: 40px; overflow: hidden; text-align: center; padding: 0 12px;">${snippet}</div>` : ''}
                                                        <div class="result-card-preview-url">${shortUrl}</div>
                                                        <a href="${safeUrl}" target="_blank" class="result-card-preview-btn" onclick="event.stopPropagation()">
                                                            Open â†’
                                                        </a>
                                                    </div>
                                                `}
                                            </div>
                                            <div class="result-card-info">
                                                <div>
                                                    <div class="result-card-title">${title}</div>
                                                    ${snippet ? `<div style="font-size: 11px; color: var(--text-secondary); margin: 6px 0; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${snippet}</div>` : ''}
                                                    <div class="result-card-url">${shortUrl}</div>
                                                </div>
                                                <div class="result-card-actions">
                                                    <button class="result-card-btn" onclick="event.stopPropagation(); window.open('${safeUrl}', '_blank')">
                                                        Open
                                                    </button>
                                                    <button class="result-card-btn result-card-btn-secondary pin-btn ${isPinned ? 'pinned' : ''}" 
                                                            onclick="event.stopPropagation(); togglePin('${safeUrl}', '${title}', '${shortUrl}')">
                                                        ${isPinned ? `
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                                                                <path d="M12 2L9 8l-7 1 5 5-1 7 6-3 6 3-1-7 5-5-7-1z"/>
                                                            </svg>
                                                        ` : `
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                <path d="M12 2L9 8l-7 1 5 5-1 7 6-3 6 3-1-7 5-5-7-1z"/>
                                                            </svg>
                                                        `}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsSection.innerHTML = html || '<div class="loading">No results found</div>';
            
            // Check iframe loads after rendering
            setTimeout(() => {
                checkIframeLoad();
            }, 100);
        }

        function displaySaved() {
            const allPinned = Object.values(state.pinned).flat();
            if (allPinned.length === 0) {
                resultsSection.innerHTML = '<div class="loading">No saved items yet. Pin some results to see them here!</div>';
                return;
            }
            
            resultsSection.innerHTML = `
                <div class="result-row">
                    <h3 class="result-row-title">Saved Items</h3>
                    <div class="result-row-carousel">
                        <div class="result-row-container">
                            ${allPinned.map(item => {
                                const title = escapeHtml(item.title);
                                const shortUrl = item.url.replace(/^https?:\/\//, '').replace(/\/$/, '');
                                return `
                                    <div class="result-card" onclick="window.open('${item.url}', '_blank')">
                                        <div class="result-card-poster">
                                            <div class="result-card-preview">
                                                <div class="result-card-icon">${getIcon(item.url)}</div>
                                                <div class="result-card-preview-title">${title}</div>
                                                <div class="result-card-preview-url">${shortUrl}</div>
                                                <a href="${item.url}" target="_blank" class="result-card-preview-btn" onclick="event.stopPropagation()">
                                                    Open â†’
                                                </a>
                                            </div>
                                        </div>
                                        <div class="result-card-info">
                                            <div>
                                                <div class="result-card-title">${title}</div>
                                                <div class="result-card-url">${shortUrl}</div>
                                            </div>
                                            <div class="result-card-actions">
                                                <button class="result-card-btn" onclick="event.stopPropagation(); window.open('${item.url}', '_blank')">
                                                    Open
                                                </button>
                                                <button class="result-card-btn result-card-btn-secondary" onclick="event.stopPropagation(); removePin('${item.url}')">
                                                    Remove
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Pin/Unpin
        function togglePin(url, title, shortUrl) {
            const collection = determineCollection(url);
            const existingIndex = state.pinned[collection].findIndex(item => item.url === url);
            
            if (existingIndex >= 0) {
                state.pinned[collection].splice(existingIndex, 1);
            } else {
                state.pinned[collection].push({
                    url,
                    title,
                    shortUrl,
                    pinnedAt: new Date().toISOString()
                });
            }
            
            savePinned();
            updateSidebar();
            displayResults(); // Refresh to update pin buttons
        }

        function removePin(url) {
            Object.keys(state.pinned).forEach(key => {
                state.pinned[key] = state.pinned[key].filter(item => item.url !== url);
            });
            savePinned();
            updateSidebar();
            if (state.mode === 'saved') {
                displaySaved();
            } else {
                displayResults();
            }
        }

        function isItemPinned(url) {
            return Object.values(state.pinned).flat().some(item => item.url === url);
        }

        function determineCollection(url) {
            if (url.includes('amazon') || url.includes('shopping')) return 'shopping';
            if (url.includes('wikipedia') || url.includes('research')) return 'research';
            if (url.includes('work') || url.includes('github') || url.includes('stackoverflow')) return 'work';
            return 'today';
        }

        // Sidebar
        function updateSidebar() {
            const collections = [
                { key: 'today', title: 'Today' },
                { key: 'research', title: 'Research' },
                { key: 'shopping', title: 'Shopping' },
                { key: 'work', title: 'Work' }
            ];
            
            sidebarContent.innerHTML = collections.map(collection => {
                const items = state.pinned[collection.key];
                return `
                    <div class="collection">
                        <div class="collection-header">
                            <span class="collection-title">${collection.title}</span>
                            <span class="collection-count">${items.length}</span>
                        </div>
                        ${items.length === 0 ? `
                            <div class="empty-collection">No items yet</div>
                        ` : items.map(item => `
                            <div class="pinned-item">
                                <div class="pinned-item-title">${escapeHtml(item.title)}</div>
                                <div class="pinned-item-url">${escapeHtml(item.shortUrl)}</div>
                                <div class="pinned-item-actions">
                                    <button class="pinned-item-btn" onclick="window.open('${item.url}', '_blank')">Open</button>
                                    <button class="pinned-item-btn" onclick="removePin('${item.url}')">Remove</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }

        // Export
        function exportPinned() {
            const allPinned = Object.values(state.pinned).flat();
            if (allPinned.length === 0) {
                alert('No pinned items to export');
                return;
            }
            
            const markdown = allPinned.map(item => `- [${item.title}](${item.url})`).join('\n');
            navigator.clipboard.writeText(markdown).then(() => {
                alert('Exported to clipboard!');
            });
        }

        function clearPinned() {
            if (confirm('Clear all pinned items?')) {
                state.pinned = { today: [], research: [], shopping: [], work: [] };
                savePinned();
                updateSidebar();
                if (state.mode === 'saved') {
                    displaySaved();
                }
            }
        }

        // Search functions
        async function searchDuckDuckGo(query) {
            const results = [];
            try {
                const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`);
                const data = await response.json();
                
                if (data.Answer) {
                    results.push({
                        url: data.AbstractURL || `https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`,
                        title: data.Heading || query,
                        snippet: data.Answer,
                        type: 'duckduckgo'
                    });
                }
                
                if (data.AbstractText) {
                    results.push({
                        url: data.AbstractURL || `https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`,
                        title: data.Heading || query,
                        snippet: data.AbstractText,
                        type: 'duckduckgo'
                    });
                }
                
                if (data.RelatedTopics && Array.isArray(data.RelatedTopics)) {
                    data.RelatedTopics.slice(0, 6).forEach(topic => {
                        if (topic && topic.FirstURL) {
                            const text = topic.Text ? topic.Text.split(' - ') : [query];
                            results.push({
                                url: topic.FirstURL,
                                title: text[0] || query,
                                snippet: text[1] || '',
                                type: 'duckduckgo'
                            });
                        }
                    });
                }
            } catch (error) {
                console.error('DuckDuckGo API error:', error);
            }
            
            if (results.length < 3) {
                results.push({
                    url: `https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`,
                    title: `DuckDuckGo Search: ${query}`,
                    type: 'duckduckgo'
                });
            }
            
            return results.length > 0 ? results : [{
                url: `https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`,
                title: `Search: ${query}`,
                type: 'duckduckgo'
            }];
        }

        async function searchGoogle(query) {
            // Try to use embeddable search URL
            return [{
                url: `https://www.google.com/search?q=${encodeURIComponent(query)}`,
                title: `Google: ${query}`,
                type: 'google',
                embeddable: true
            }, {
                url: `https://www.google.com/search?q=${encodeURIComponent(query)}&tbm=isch`,
                title: `Google Images: ${query}`,
                type: 'google',
                snippet: 'Search images for: ' + query,
                embeddable: true
            }, {
                url: `https://www.google.com/search?q=${encodeURIComponent(query)}&tbm=vid`,
                title: `Google Videos: ${query}`,
                type: 'google',
                snippet: 'Search videos for: ' + query,
                embeddable: true
            }];
        }

        async function searchBing(query) {
            return [{
                url: `https://www.bing.com/search?q=${encodeURIComponent(query)}&FORM=HDRSC1`,
                title: `Bing: ${query}`,
                embeddable: true
            }, {
                url: `https://www.bing.com/images/search?q=${encodeURIComponent(query)}`,
                title: `Bing Images: ${query}`,
                embeddable: true
            }];
        }

        async function searchAmazon(query) {
            return [{
                url: `https://www.amazon.com/s?k=${encodeURIComponent(query)}`,
                title: `Amazon: ${query}`
            }, {
                url: `https://www.amazon.com/s?k=${encodeURIComponent(query)}&i=electronics`,
                title: `Amazon Electronics: ${query}`
            }, {
                url: `https://www.amazon.com/s?k=${encodeURIComponent(query)}&i=fashion`,
                title: `Amazon Fashion: ${query}`
            }];
        }

        async function searchChatGPT(query) {
            return [{
                url: `https://chat.openai.com/?q=${encodeURIComponent(query)}`,
                title: `ChatGPT: ${query}`,
                snippet: 'Ask ChatGPT about: ' + query,
                type: 'chatgpt'
            }, {
                url: `https://chat.openai.com/`,
                title: `ChatGPT Home`,
                type: 'chatgpt'
            }];
        }

        async function searchClaude(query) {
            return [{
                url: `https://claude.ai/chat?q=${encodeURIComponent(query)}`,
                title: `Claude: ${query}`,
                snippet: 'Ask Claude about: ' + query,
                type: 'claude'
            }, {
                url: `https://claude.ai/`,
                title: `Claude Home`,
                type: 'claude'
            }];
        }

        async function searchGemini(query) {
            return [{
                url: `https://gemini.google.com/app?q=${encodeURIComponent(query)}`,
                title: `Gemini: ${query}`,
                snippet: 'Ask Google Gemini about: ' + query,
                type: 'gemini'
            }, {
                url: `https://gemini.google.com/app`,
                title: `Gemini Home`,
                type: 'gemini'
            }];
        }

        async function searchPerplexity(query) {
            return [{
                url: `https://www.perplexity.ai/search?q=${encodeURIComponent(query)}`,
                title: `Perplexity: ${query}`,
                snippet: 'Search with Perplexity: ' + query,
                type: 'perplexity'
            }, {
                url: `https://www.perplexity.ai/`,
                title: `Perplexity Home`,
                type: 'perplexity'
            }];
        }

        async function searchCopilot(query) {
            return [{
                url: `https://copilot.microsoft.com/?q=${encodeURIComponent(query)}`,
                title: `Copilot: ${query}`,
                snippet: 'Ask Microsoft Copilot about: ' + query,
                type: 'copilot'
            }, {
                url: `https://copilot.microsoft.com/`,
                title: `Copilot Home`,
                type: 'copilot'
            }];
        }

        async function searchGrok(query) {
            return [{
                url: `https://x.com/i/grok?q=${encodeURIComponent(query)}`,
                title: `Grok: ${query}`,
                snippet: 'Ask Grok about: ' + query,
                type: 'grok'
            }, {
                url: `https://x.com/i/grok`,
                title: `Grok Home`,
                type: 'grok'
            }];
        }

        async function searchHuggingChat(query) {
            return [{
                url: `https://huggingface.co/chat/?q=${encodeURIComponent(query)}`,
                title: `HuggingChat: ${query}`,
                snippet: 'Ask HuggingChat about: ' + query,
                type: 'huggingchat'
            }, {
                url: `https://huggingface.co/chat/`,
                title: `HuggingChat Home`,
                type: 'huggingchat'
            }];
        }

        async function searchYou(query) {
            return [{
                url: `https://you.com/search?q=${encodeURIComponent(query)}`,
                title: `You.com: ${query}`,
                snippet: 'Search with You.com: ' + query,
                type: 'you'
            }, {
                url: `https://you.com/`,
                title: `You.com Home`,
                type: 'you'
            }];
        }

        async function searchYouTube(query) {
            return [{
                url: `https://www.youtube.com/embed?listType=search&list=${encodeURIComponent(query)}`,
                title: `YouTube Videos: ${query}`,
                embeddable: true,
                type: 'youtube'
            }, {
                url: `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`,
                title: `YouTube Search: ${query}`,
                type: 'youtube'
            }];
        }

        async function searchWikipedia(query) {
            const cleanQuery = query.replace(/\s+/g, '_');
            return [{
                url: `https://en.wikipedia.org/wiki/${encodeURIComponent(cleanQuery)}`,
                title: `Wikipedia: ${query}`,
                embeddable: true
            }, {
                url: `https://en.m.wikipedia.org/wiki/${encodeURIComponent(cleanQuery)}`,
                title: `Wikipedia (Mobile): ${query}`,
                embeddable: true
            }, {
                url: `https://en.wikipedia.org/wiki/Special:Search/${encodeURIComponent(query)}`,
                title: `Wikipedia Search: ${query}`,
                embeddable: true
            }];
        }

        async function searchReddit(query) {
            return [{
                url: `https://www.reddit.com/search/?q=${encodeURIComponent(query)}`,
                title: `Reddit: ${query}`,
                embeddable: true
            }, {
                url: `https://www.reddit.com/r/all/search/?q=${encodeURIComponent(query)}&restrict_sr=1`,
                title: `Reddit All: ${query}`,
                embeddable: true
            }];
        }

        // Utilities
        function getIcon(url) {
            if (url.includes('google')) return 'ðŸ”';
            if (url.includes('youtube')) return 'â–¶ï¸';
            if (url.includes('wikipedia')) return 'ðŸ“š';
            if (url.includes('reddit')) return 'ðŸ’¬';
            if (url.includes('amazon')) return 'ðŸ›’';
            if (url.includes('duckduckgo')) return 'ðŸ¦†';
            if (url.includes('bing')) return 'ðŸ”Ž';
            if (url.includes('chatgpt') || url.includes('openai')) return 'ðŸ¤–';
            if (url.includes('claude')) return 'ðŸ§ ';
            if (url.includes('gemini')) return 'ðŸ’Ž';
            if (url.includes('perplexity')) return 'ðŸ”®';
            if (url.includes('copilot')) return 'âœˆï¸';
            if (url.includes('grok')) return 'âš¡';
            if (url.includes('huggingchat') || url.includes('huggingface')) return 'ðŸ¤—';
            if (url.includes('you.com')) return 'ðŸ‘¤';
            return 'ðŸŒ';
        }

        function shouldAttemptIframe(url) {
            // Try iframe for these domains
            const iframeFriendly = [
                'wikipedia.org',
                'wikimedia.org',
                'github.com',
                'stackoverflow.com',
                'medium.com',
                'dev.to',
                'reddit.com',
                'youtube.com',
                'vimeo.com'
            ];
            return iframeFriendly.some(domain => url.includes(domain));
        }

        function handleIframeError(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                const iframe = card.querySelector('.result-card-embed');
                const fallback = card.querySelector('.result-card-fallback');
                if (iframe && fallback) {
                    iframe.style.display = 'none';
                    fallback.style.display = 'flex';
                }
            }
        }

        // Suppress console errors and warnings from iframes
        // These warnings come from embedded sites (YouTube, Bing, etc.) and can't be fixed
        const originalError = console.error;
        const originalWarn = console.warn;
        const originalLog = console.log;
        const originalInfo = console.info;
        const originalDebug = console.debug;
        
        const shouldSuppress = (message) => {
            if (!message) return false;
            const msg = typeof message === 'string' ? message : String(message);
            const lowerMsg = msg.toLowerCase();
            return (
                lowerMsg.includes('permissions policy violation') ||
                lowerMsg.includes('blocked autofocusing') ||
                lowerMsg.includes('x-frame-options') ||
                lowerMsg.includes('content security policy') ||
                lowerMsg.includes('frame-ancestors') ||
                lowerMsg.includes('domnodeinserted') ||
                lowerMsg.includes('domnoderemoved') ||
                lowerMsg.includes('instrumentationtracker') ||
                lowerMsg.includes('deprecation') ||
                lowerMsg.includes('chromestatus.com') ||
                lowerMsg.includes('mutation event') ||
                lowerMsg.includes('listener added for a') ||
                lowerMsg.includes('support for this event type has been removed') ||
                lowerMsg.includes('feature/5083947249172480') ||
                msg.includes('.br.js') // YouTube/Bing minified files
            );
        };
        
        const filterConsole = (originalFn) => {
            return function(...args) {
                // Check all arguments for suppressible messages
                const allMessages = args.map(arg => {
                    if (typeof arg === 'string') return arg;
                    if (arg && arg.toString) return arg.toString();
                    return String(arg);
                }).join(' ');
                
                if (shouldSuppress(allMessages)) {
                    return; // Suppress this message
                }
                originalFn.apply(console, args);
            };
        };
        
        console.error = filterConsole(originalError);
        console.warn = filterConsole(originalWarn);
        console.log = filterConsole(originalLog);
        console.info = filterConsole(originalInfo);
        console.debug = filterConsole(originalDebug);
        
        // Also try to suppress at the DevTools level by overriding console methods early
        // Note: Some deprecation warnings are logged directly by Chrome DevTools
        // and cannot be suppressed via JavaScript, but we try our best

        // Check if iframe loaded successfully
        function checkIframeLoad() {
            document.querySelectorAll('.result-card-embed').forEach(iframe => {
                if (!iframe.src.includes('youtube.com')) {
                    const card = iframe.closest('.result-card');
                    const fallback = card?.querySelector('.result-card-fallback');
                    
                    if (fallback) {
                        // Set timeout to check if iframe loaded
                        setTimeout(() => {
                            try {
                                // Try to access iframe content - if it fails, show fallback
                                if (iframe.contentWindow) {
                                    // Check if iframe actually loaded content
                                    try {
                                        // This will throw if cross-origin
                                        const test = iframe.contentWindow.location;
                                    } catch (e) {
                                        // Cross-origin - check if it's actually blocked
                                        // If iframe height is 0 or very small, it's likely blocked
                                        if (iframe.offsetHeight < 50) {
                                            iframe.style.display = 'none';
                                            fallback.style.display = 'flex';
                                        }
                                    }
                                }
                            } catch (e) {
                                // Cross-origin blocked - show fallback
                                iframe.style.display = 'none';
                                fallback.style.display = 'flex';
                            }
                        }, 1500);
                        
                        // Also listen for load errors
                        iframe.addEventListener('error', () => {
                            iframe.style.display = 'none';
                            fallback.style.display = 'flex';
                        }, { once: true });
                    }
                }
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Global functions
        window.togglePin = togglePin;
        window.removePin = removePin;
        window.handleIframeError = handleIframeError;

        // Initialize
        updateSidebar();
        searchInput.focus();
    </script>
</body>
</html>
